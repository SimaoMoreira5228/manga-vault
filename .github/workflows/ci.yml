name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  fmt:
    name: "Fmt"
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Install dotslash
        run: curl -LSfs "https://github.com/facebook/dotslash/releases/latest/download/dotslash-ubuntu-22.04.$(uname -m).tar.gz" | tar fxz - -C /usr/local/bin dotslash

      - uses: dprint/check@v2.3

  eslint:
    name: "ESLint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable pnpm via corepack
        run: corepack enable pnpm

      - name: Install dependencies
        run: pnpm install
        working-directory: ./apps/website

      - name: Run ESLint
        run: pnpm run ci:lint
        working-directory: ./apps/website

  clippy:
    name: "Rust: clippy (stable)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo registry & git index
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v0-rust-ci"
          cache-on-failure: true
          shared-key: "rust-ci-${{ runner.os }}"

      - name: Run clippy (stable)
        run: cargo clippy --all-features --all-targets --no-deps -- -D warnings
        shell: bash

  test:
    name: "Rust: tests"
    runs-on: ubuntu-latest
    services:
      byparr:
        image: ghcr.io/thephaseless/byparr:latest
        ports:
          - 8191:8191
        options: >-
          --health-cmd "curl -fsS http://localhost:8191/health >/dev/null || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install dotslash
        run: curl -LSfs "https://github.com/facebook/dotslash/releases/latest/download/dotslash-ubuntu-22.04.$(uname -m).tar.gz" | tar fxz - -C /usr/local/bin dotslash

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rust-src

      - name: Cache Cargo registry & git index
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v0-rust-ci"
          cache-on-failure: true
          shared-key: "rust-ci-${{ runner.os }}"

      - name: Install cargo-binstall
        run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install cargo-component
        run: cargo binstall -y cargo-component

      - name: Build wasm plugin and run tests
        run: |
          set -euo pipefail
          cargo component build --target wasm32-wasip1 --release --package mangaread_org

          export VAULT_TEST_WASM_PLUGIN="$(pwd)/target/wasm32-wasip1/release/mangaread_org.wasm"
          echo "VAULT_TEST_WASM_PLUGIN=$VAULT_TEST_WASM_PLUGIN"
          export VAULT_TEST_WASM_PLUGIN_MANGA_URL="https://www.mangaread.org/manga/solo-leveling-manhwa/"
          echo "VAULT_TEST_WASM_PLUGIN_MANGA_URL=$VAULT_TEST_WASM_PLUGIN_MANGA_URL"

          ./tools/chromedriver.dotslash run --port=4444 &
          chromedriver_pid=$!
          trap 'kill $chromedriver_pid 2>/dev/null || true' EXIT

          export LUA_PLUGIN_TEST_DIR="$(pwd)/scrapers/"

          export LUA_PLUGIN_TEST_FLARESOLVERR_URL="http://localhost:8191"
          export LUA_PLUGIN_TEST_HEADLESS_URL="http://localhost:4444"

          INSTA_FORCE_PASS=1 cargo test --workspace --all-features -- --nocapture
        shell: bash
